# dirty toolset

Набор инструментов для работы с API d3.ru.
Для большинства инструментов нужен золотой аккаунт.

---

## Переменные окружения
Создайте файл `.env` в корне репозитория и никогда его не добавляйте в коммит.

Содержимое должно выглядеть примерно следующим образом:

```
SID=...
UID=...
CSRF=...
DATA=/local/data
```

Заполните реальными значениями:
`SID`, `UID` и `CSRF` вы найдете в консоли своего браузера.
`DATA` - абсолютный путь к директории, в которой вы хотите хранить данные. Эта директория может быть вне репозитория или в другом репозитории.


## Разработка и поддержка

- `npm run test` – тесты.
- `npm run coverage` – code coverage.
- `npm run check` – проверить код с помощью [Google TypeScript Style](https://github.com/google/gts).
- `npm run fix` – исправить код с помощью [Google TypeScript Style](https://github.com/google/gts).


## Инструменты, которые могут вам пригодиться `/tools`

Общие инструменты для работы с API d3.ru:

- `npm run votes <username>` - сгенерировать JSON-отчеты по голосам в посты, комментарии и карму пользователя. Эта команда создаст следующие файлы в папке `DATA` (см. `.env`):
  - `<username>-delayed-votes.json` - голоса в посты и комментарии пользователя, которые поставлены через три и более суток с момента написания соответствующего поста или комментария.
  - `<username>-votes.json` - все голоса в посты и комментарии пользователя.
  - `<username>-voters.json` - сводка по всем голосующим в посты и комментарии пользователя. Голосующие отсортированы по сумме всех голосов (с учётом веса голоса).

- `npm run karma <username>` - сгенерировать JSON-отчет по голосам в карму пользователя. Эта команда создаст следующие файл в папке `DATA` (см. `.env`):
  - `<username>-karma.json` - голоса в карму пользователя.


## Поддержка `/maintenance`

Эти инструменты могут пригодиться разве что как примеры.
Их назначение – поддержка сайта https://romaklimenko.github.io/dirty.


* `npm run maintenance:cache:db <fromId> <toId>` – сохранить в mongo пользователей с id от `fromId` до `toId`. И голоса в их карму.
* `npm run maintenance:cache:json` – создать JSON-файлы со списком пользователей и JSON-файлы с исходящими голосами пользователя (по файлу на каждого пользователя).
* `npm run maintenance:cache:upload` – загрузить JSON-файлы с кармой в Google Cloud Storage.


### Эксперименты `/experiments`

Сбор данных для постов на https://dataisbeautiful.d3.ru/, https://reports.d3.ru/ и т.п.